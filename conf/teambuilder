# nginx configuration file for teambuilder site
# location: /etc/nginx/sites-available/teambuilder
# NOTE: /etc/nginx/sites-enabled/teambuilder is a symlink to the above location

server {
	listen 80 default_server;
	server_name _;

	# redirect to https
	location / {
		rewrite ^ https://$http_host$request_uri? permanent;
	}
}

server {
	listen 443 default_server;
	server_name _;

	# pretend we got the request over https
	set $ssl on;
	
	# landing page doesn't require auth
	location = / {
		include uwsgi_params;
		uwsgi_pass unix:/opt/deco3801-allotech/teambuilder/teambuilder.sock;
	}

	# static stuff doesn't require auth
	location /static {
		include uwsgi_params;
		uwsgi_pass unix:/opt/deco3801-allotech/teambuilder/teambuilder.sock;
	}

	# default location for anything that doesn't match the above locations.
	# requires authentication
	location / {
		include "set_cookie.conf";
		rewrite_by_lua_file "lua/auth_filter.lua";
		include uwsgi_params;
		uwsgi_pass unix:/opt/deco3801-allotech/teambuilder/teambuilder.sock;
	}
}
